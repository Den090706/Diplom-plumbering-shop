<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Панель адміністратора</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #f9f9f9;
  }

  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 150px;
    height: 100%;
    background-color: #e6f4f8;
    padding-top: 20px;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
  }

  .sidebar button {
    display: block;
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    background-color: #37ddf3;
    color: black;
    border: none;
    text-align: left;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .sidebar button:hover {
    background-color: #2ac1d5;
  }

  .admin-container {
    margin-left: 170px;
    padding: 20px;
  }

  #login-section, #admin-panel, .form,
  #categoryForm, #subcategoryForm {
    margin-top: 20px;
    padding: 20px;
  }

  .admin-panel .btn {
    margin: 10px;
    padding: 10px 20px;
    background-color: #37ddf3;
    color: black;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .admin-panel .btn:hover {
    background-color: #37ddf3;
    color: black;
  }

  .form {
    display: none;
    margin-top: 20px;
    margin-left: 170px;
}

  .add-options {
    margin-top: 20px;
  }

  .add-options button {
    margin-right: 10px;
    padding: 10px;
    margin-left: 170px;
  }

  #editOptions button {
    margin-right: 10px;
    padding: 10px;
    margin-left: 170px;
  }


  #category, #subcategory {
    color: black;
    background-color: #e6f4f8;
  }
</style>

<body>
  <!-- Бокова панель -->
  <div class="sidebar">
    <button class="sidebar-btn" data-target="main.html">Головна</button>
    <button class="sidebar-btn" data-target="aboutUs.html">Про нас</button>
    <button class="sidebar-btn" data-target="admin.html">Увійти як адміністратор</button>
  </div>

  <!-- Правий контент -->
  <div class="admin-container">
    <!-- Вхід адміністратора -->
    <section id="login-section">
      <h2>Вхід адміністратора</h2>
      <form id="adminLoginForm">
        <label for="password">Пароль:</label>
        <input type="password" id="password" name="password">
        <button type="submit">Увійти</button>
      </form>
      <p id="loginMessage"></p>
    </section>

    <!-- Панель адміністратора -->
    <section id="admin-panel" class="admin-panel" style="display: none;">
      <h2>Панель адміністратора</h2>
      <button class="btn" onclick="showAddOptions()">Додати</button>
      <button class="btn" onclick="showEditOptions()">Редагувати</button>
      <button class="btn" onclick="showDeleteOptions()">Видалити</button>
      
      <button onclick="cleanupImages()">Очистити зайві зображення</button>
      <div id="cleanup-result"></div>
    </section>

<!-- ДОДАВАННЯ -->
    <!-- Вибір дії для Додати-->
    <div class="add-options" id="addOptions" style="display: none;">
      <button onclick="showForm('productForm')">Товар</button>
      <button onclick="showForm('subcategoryForm')">Підкатегорію</button>
      <button onclick="showForm('categoryForm')">Категорію</button>
    </div>

    <!-- Форма додавання товару -->
    <div id="productForm" class="form">
      <h3>Додати товар</h3>
      <form id="addProductForm" enctype="multipart/form-data" method="POST">
        <img id="currentItemImage" src="" alt="Зображення товару" style="max-width: 200px;"><br><br>
        <input type="file" id="editItemImage" name="image" accept="image/*">
        <input type="text" id="productName" name="name" placeholder="Назва товару" required>
        <select id="category" name="category" required></select>
        <select id="subcategory" name="subcategory"></select>
        <textarea id="productDescription" name="description" placeholder="Опис" required></textarea>
        <input type="number" id="productPrice" name="price" placeholder="Ціна" step="0.01" required>
        <input type="number" id="productStock" name="stock" placeholder="Кількість" required>
        <button type="submit">Додати товар</button>
      </form>
    </div>

<!-- Форма додавання підкатегорії -->
    <div id="subcategoryForm" class="form">
      <h3>Додати підкатегорію</h3>
      <form id="addSubcategoryForm">
        <select id="subcategoryCategory" required></select>
        <input type="text" id="subcategoryName" placeholder="Назва підкатегорії" required>
        <button type="submit">Додати підкатегорію</button>
      </form>
    </div>
  </div>

    <!-- Форма додавання категорії -->
    <div id="categoryForm" class="form">
      <h3>Додати категорію</h3>
      <form id="addCategoryForm">
        <input type="text" id="categoryName" placeholder="Назва категорії" required>
        <button type="submit">Додати категорію</button>
      </form>
    </div>

<!-- РЕДАГУВАННЯ -->
 <!-- Вибір для редагування -->
<div class="edit-options" id="editOptions" style="display: none;">
  <button onclick="showForm('selectItemToEdit')">Товар</button>
  <button onclick="showForm('selectSubcategoryToEdit')">Підкатегорію</button>
  <button onclick="showForm('selectCategoryToEdit')">Категорію</button>
</div>

<!-- Вибір товару -->
<div id="selectItemToEdit" class="form" style="display: none;">
  <h3>Оберіть товар для редагування</h3>
  <select id="editItemSelect" required></select>
  <button id="loadItemDataBtn" type="button">Вибрати</button>
</div>

<!-- Форма редагування товару -->
<div id="editItemForm" class="form" style="display: none;">
  <h3>Редагувати товар</h3>
  <form id="editItemFormElement">
    <input type="hidden" id="editItemIdItem">

    <label>Назва товару (поточна): <span id="currentItemName"></span></label>
    <input type="text" id="editItemNameItem" placeholder="Нова назва товару">

    <label>Ціна (поточна): <span id="currentPrice"></span></label>
    <input type="number" id="editPriceItem" placeholder="Нова ціна" step="0.01" min="0">

    <label>Поточне зображення:</label><br>
    <img id="currentImage" src="/uploads/products/no-image.jpg" alt="Поточне зображення" width="150">

    <label>Оновити зображення:</label>
    <input type="file" id="editImageItem" accept="image/*">

    <label>Категорія (поточна): <span id="currentCategoryName"></span></label>
    <select id="editCategoryItem"></select>

    <label>Підкатегорія (поточна): <span id="currentSubcategoryName"></span></label>
    <select id="editSubcategoryItem"></select>
    
    <label>Кількість (поточна): <span id="currentQuantity"></span></label>
    <input type="number" id="editQuantityItem" placeholder="Нова кількість" min="0">

    <label>Опис (поточний): <span id="currentDescription"></span></label>
    <textarea id="editDescriptionItem" placeholder="Новий опис"></textarea>

    <button type="submit">Оновити товар</button>
  </form>
</div>

<!-- Вибір підкатегорії -->
<div id="selectSubcategoryToEdit" class="form" style="display: none;">
  <h3>Оберіть підкатегорію для редагування</h3>

  <label for="editSubcategoryCategorySelect">Категорія:</label>
  <select id="editSubcategoryCategorySelect" required></select>

  <label for="editSubcategorySelect">Підкатегорія: </label>
  <select id="editSubcategorySelect" required></select>
  
  <button id="loadSubcategoryDataBtn" type="button">Вибрати</button>
</div>

<!-- Форма редагування підкатегорії -->
<div id="editSubcategoryForm" class="form" style="display: none;">
  <h3>Редагувати підкатегорію</h3>
  <form id="editSubcategoryFormElement">
    <input type="hidden" id="editSubcategoryId">
    
    <label>Назва підкатегорії (поточна): <span id="currentSubcategoryNameSub"></span></label>

    <label for="editSubcategoryCategoryNameInForm">Оберіть категорію:</label>
    <select id="editSubcategoryCategoryNameInForm" required></select>

    <label for="editSubcategoryName">Нова назва підкатегорії:</label>
    <input type="text" id="editSubcategoryName" placeholder="Нова назва підкатегорії" required>

    <button type="submit">Оновити підкатегорію</button>
  </form>
</div>

<!-- Вибір категорії -->
<div id="selectCategoryToEdit" class="form" style="display: none;">
  <h3>Оберіть категорію для редагування</h3>
  <select id="editCategorySelect" required></select>
  <button id="loadCategoryDataBtn" type="button">Вибрати</button>
</div>

<!-- Форма редагування категорії -->
<div id="editCategoryForm" class="form" style="display: none;">
  <h3>Редагувати категорію</h3>
  <form id="editCategoryFormElement">
    <input type="hidden" id="editCategoryCategoryId">

    <label>Категорія (поточна): <span id="currentCategoryNameCat"></span></label>
    
    <label>Нова назва категорії: </label>
    <input type="text" id="editCategoryName" placeholder="Нова назва" required>

    <button type="submit">Оновити категорію</button>
  </form>
</div>

<!-- ВИДАЛЕННЯ -->
<!-- Вибір для видалення -->
<div class="edit-options" id="editOptions" style="display: none;">
  <button onclick="showForm('selectItemToDelete')">Товар</button>
  <button onclick="showForm('selectSubcategoryToDelete')">Підкатегорію</button>
  <button onclick="showForm('selectCategoryToDelete')">Категорію</button>
</div>

<!-- Вибір товару -->
<div id="selectItemToDelete" class="form" style="display: none;">
  <h3>Оберіть товар для видалення</h3>
  <select id="editItemSelect" required></select>
  <button id="loadItemToDeleteBtn" type="button">Вибрати</button>
</div>

<!-- Форма видалення товару -->
<div id="deleteItemForm" class="form" style="display: none;">
  <h3>Видалення товару</h3>
  <form id="deleteItemFormElement" method="post">
    <input type="hidden" id="deleteItemIdItem">

    <label>Назва товару (поточна): <span id="currentItemName"></span></label>

    <label>Ціна (поточна): <span id="currentPrice"></span></label>

    <label>Поточне зображення:</label><br>
    <img id="currentImage" src="/uploads/products/no-image.jpg" alt="Поточне зображення" width="150">

    <label>Категорія (поточна): <span id="currentCategoryName"></span></label>

    <label>Підкатегорія (поточна): <span id="currentSubcategoryName"></span></label>
    
    <label>Кількість (поточна): <span id="currentQuantity"></span></label>

    <label>Опис (поточний): <span id="currentDescription"></span></label>

    <button type="submit">Видалити товар</button>
  </form>
</div>

<script>
// Навігація
document.querySelectorAll('.sidebar-btn').forEach(button => {
  button.addEventListener('click', () => {
    location.href = button.dataset.target;
  });
});

// URL для запитів
// locoal const API_BASE = 'http://localhost:3000';
const API_BASE = 'https://diplom-plumbering-shop.onrender.com';
    
  // Авторизація
document.getElementById('adminLoginForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const password = document.getElementById('password').value;
  const loginMessage = document.getElementById('loginMessage');

      try {
        const response = await fetch(`${API_BASE}/api/admin_password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          document.getElementById('admin-panel').style.display = 'block';
          document.getElementById('adminLoginForm').style.display = 'none';
          loginMessage.textContent = '';
        } else {
          loginMessage.textContent = result.message || 'Невірний пароль';
        }
      } catch (error) {
        console.error('Помилка запиту:', error);
        loginMessage.textContent = 'Помилка сервера або мережі';
      }
    });

// Після завантаження сторінки
document.addEventListener('DOMContentLoaded', () => {
  loadCategories('category');
  loadCategories('editCategoryItem');
  loadSubcategories('category', 'subcategory');
  loadSubcategories('editCategoryItem', 'editSubcategoryItem');
  loadCategories('editSubcategoryCategorySelect');
  loadCategories('editSubcategoryCategoryNameInForm');
  loadCategories('subcategoryCategory');
  loadItemsForEdit();
});

// Приховує всі форми з класом .form і показує лише одну
function showForm(formId) {
  document.querySelectorAll('.form').forEach(form => {
    form.style.display = 'none';
  });
  const target = document.getElementById(formId);
  if (target) target.style.display = 'block';
}

// Універсальна функція, яка ховає всі блоки режимів
function hideAllModes() {
  document.getElementById('addOptions').style.display = 'none';
  document.getElementById('editOptions').style.display = 'none';

  const deleteOptions = document.getElementById('deleteOptions');
  if (deleteOptions) {
    deleteOptions.style.display = 'none';
  }
}

// ДОДАВАННЯ 
// Показати форми для Додавання
function showAddOptions() {
  hideAllModes();
  showForm(); // ховає всі форми
  document.getElementById('addOptions').style.display = 'block';
}
function showAddProductForm() {
  showForm('productForm');
}
function showAddCategoryForm() {
  showForm('categoryForm');
}
function showAddSubcategoryForm() {
  showForm('subcategoryForm');
}

// Завантаження категорій
function loadCategories(selectId, selectCategoryId = null) {
  const select = document.getElementById(selectId);
    if (!select) {
      console.error(`Елемент із id "${selectId}" не знайдено`);
      return;
    }

  fetch(`${API_BASE}/api/categories`)
    .then(res => {
      if (!res.ok) throw new Error('Не вдалося завантажити категорії');
      return res.json();
    })
    .then(data => {
      console.log('Категорії з API:', data); // видилити потім
      const select = document.getElementById(selectId);

      select.innerHTML = '<option value="">Оберіть категорію</option>';
      
      if (!Array.isArray(data)) {
        console.error('Очікувався масив, але отримав: ', data);
        return;
      }
      
      data.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.category_id || cat.id;
        option.textContent = cat.category_name || cat.name;  
        
        if (selectCategoryId && String(option.value) == String(selectCategoryId)){
          option.selected = true;
        }
        select.appendChild(option);
        });
      }) 
    .catch(err => console.error('Помилка при завантаженні категорій:', err));
}

// Завантаження підкатегорій при виборі категорії
function loadSubcategories(categorySelectId, subcategorySelectId) {
  const catSelect = document.getElementById(categorySelectId);
  const subSelect = document.getElementById(subcategorySelectId);

  if (!catSelect || !subSelect) {
    console.error(`Один з елементів не знайдено: catSelect = ${catSelect}, subSelect = ${subSelect}`);
    return;
  }

  catSelect.addEventListener('change', () => {
    const categoryId = catSelect.value;

    if(!categoryId || categoryId === ""){
      console.warn('Категорія не вибрана');
      return;
    }

    console.log('Отримано value категорії:', categoryId);
    subSelect.innerHTML = '<option value="">Оберіть підкатегорію</option>';

    fetch(`${API_BASE}/api/subcategories/${categoryId}`) // /api/categories/:categoryId/subcategories
      .then(res => res.json())
      .then(data => {
        console.log('Отримано підкатегорії:', data);
        if (data.error) {
          console.warn('Сервер повернув помилку:', data.error);
          return;
        }

        if (!Array.isArray(data)) {
          console.error('Помилка: очікувався масив, але прийшло:', data);
          return;
        }

        data.forEach(sub => {
          const option = document.createElement('option');
          option.value = sub.id;
          option.textContent = sub.subcategory_name || sub.name;
          subSelect.appendChild(option);
        });
      })
      .catch(error => {
          console.error('Помилка при отриманні підкатегорій:', error);
      });
  });
}

// Додавання товару
  document.getElementById('addProductForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const form = document.getElementById('addProductForm');
  const formData = new FormData();

  // Зображення
  const imageFile = document.getElementById('editItemImage').files[0];
  if (imageFile) {
    formData.append('image', imageFile);
  }

  // Інші поля
  formData.append('name', document.getElementById('productName').value);
  formData.append('category_id', document.getElementById('category').value);
  formData.append('subcategory_id', document.getElementById('subcategory').value || '');
  formData.append('description', document.getElementById('productDescription').value);
  formData.append('price', document.getElementById('productPrice').value.replace(',', '.'));
  formData.append('stock', document.getElementById('productStock').value);

  fetch(`${API_BASE}/api/products`, {
    method: 'POST',
    body: formData
  })
    .then(res => res.json())
    .then(result => {
      alert(result.message || 'Товар додано');
      form.reset();
      document.getElementById('currentItemImage').src = '';
    })
    .catch(error => {
      console.error('Помилка при додаванні товару:', error);
      alert('Сталася помилка при додаванні товару');
    });
});


// Додавання підкатeгорії
  document.getElementById('addSubcategoryForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const data = {
    name: document.getElementById('subcategoryName').value,
    category_id: document.getElementById('subcategoryCategory').value
  };
  
  console.log('API_BASE:', API_BASE);
  console.log('name:', data.name);
  console.log('category_id:', data.category_id);
  fetch(`${API_BASE}/api/subcategories`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(res => res.json())
    .then(result => {
      alert(result.message || 'Підкатегорію додано');
      document.getElementById('addSubcategoryForm').reset();
    })
    .catch(error => {
      console.error('Помилка при додаванні підкатегорії:', error);
      alert('Сталася помилка при додаванні підкатегорії');
    });
});

    // Додавання катeгорії 
    document.getElementById('addCategoryForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const data = {
    name: document.getElementById('categoryName').value,
  };
  
  console.log('API_BASE:', API_BASE);
  fetch(`${API_BASE}/api/categories`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(res => res.json())
    .then(result => {
      alert(result.message || 'Категорію додано');
      document.getElementById('addCategoryForm').reset();
    })
    .catch(error => {
      console.error('Помилка при додаванні категорії:', error);
      alert('Сталася помилка при додаванні категорії');
    });
});

// РЕДАГУВАННЯ 
// Показати вибір дій для редагування
 function showEditOptions() {
  hideAllModes();
  showForm(); 
  document.getElementById('editOptions').style.display = 'block';
  
  loadItemsForEdit();
}
function showEditProductForm() {
  showForm('editItemForm');
}
function showEditCategoryForm() {
  showForm('selectCategoryToEdit');
}
function showEditSubcategoryForm() {
  showForm('selectSubcategoryToEdit');
}

// Редагування товару
// Підтягнути список товарів у select
function loadItemsForEdit() {
  fetch(`${API_BASE}/api/products`)
    .then(res => res.json())
    .then(data => {
      console.log('Завантажені товари:', data);
      const select = document.getElementById('editItemSelect');
      select.innerHTML = '<option value="">-- Виберіть товар --</option>';

      if (Array.isArray(data)) {
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item.product_id;
          option.textContent = item.name;
          select.appendChild(option);
        });
      } else {
        console.error('Очікував масив, але отримав:', data);
      }
    })
    .catch(err => console.error('Помилка при завантаженні товарів:', err));
}

// При натисканні "Вибрати"
document.getElementById('loadItemDataBtn').addEventListener('click', () => {
  const itemId = document.getElementById('editItemSelect').value;
  console.log('ID товару:', itemId);

  if (!itemId){
    alert ("Оберіть товар зі списку");
    return;
  };

  fetch(`${API_BASE}/api/products/${itemId}`)
    .then(res => {
      if (!res.ok) throw new Error('Не вдалося завантажити товар');
      return res.json();
    })
    .then(item => {
      console.log('Отриманий товар з API:', item);

      if (Array.isArray(item)) item = item[0];
      if (!item || !item.id) throw new Error('Невірні дані товару');
      console.log('Завантажені товари:', item);

      // Заповнення полів
      document.getElementById('editItemIdItem').value = item.id;
      
      document.getElementById('currentItemName').textContent = item.name || '';
      document.getElementById('editItemNameItem').value = item.name || '';
      
      document.getElementById('currentDescription').textContent = item.description || '';
      document.getElementById('editDescriptionItem').value = item.description || '';
      
      document.getElementById('currentCategoryName').textContent = item.category_name || '';
      document.getElementById('currentSubcategoryName').textContent = item.subcategory_name || '';
      
      document.getElementById('currentQuantity').textContent = item.stock ?? '0';
      document.getElementById('editQuantityItem').value = item.stock ?? '';

      document.getElementById('currentPrice').textContent = item.price ?? '0.00';
      document.getElementById('editPriceItem').value = item.price ?? '';

      const imgEl = document.getElementById('currentImage');
      if (imgEl) {
        imgEl.src = item.image && item.image.trim() !== '' ? item.image : '/uploads/products/no-image.jpg';
      }
      console.log('item:', item);
  
      return Promise.all([
      // Завантаження категорій
      loadCategories('editCategoryItem', item.category_id),
      // Завантаження підкатегорій
      loadSubcategories('editCategoryItem', 'editSubcategoryItem')
      ]);
    })
    .then(() => {
      // Показати форму після завантаження всіх даних
      document.getElementById('editItemForm').style.display = 'block';
    })
    .catch(err => {
      console.error(err);
    });
    console.log('Обраний товар:', itemId);
    console.log('У select зараз є опції:', [...document.getElementById('editItemSelect').options].map(o => o.textContent));

// Надсилання оновлення
document.getElementById('editItemFormElement').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const id = document.getElementById('editItemIdItem').value;
  
  const formData = new FormData();
  formData.append('name', document.getElementById('editItemNameItem').value);
  formData.append('category_id', document.getElementById('editCategoryItem').value);
  formData.append('subcategory_id', document.getElementById('editSubcategoryItem').value);
  formData.append('description', document.getElementById('editDescriptionItem').value);
  formData.append('stock', document.getElementById('editQuantityItem').value);
  formData.append('price', document.getElementById('editPriceItem').value);

  const imageFile = document.getElementById('editImageItem').files[0];
  if (imageFile) {
    formData.append('image', imageFile);
  }

  fetch(`${API_BASE}/api/products/${id}`, {
    method: 'PUT',
    body: formData
  })
    .then(async res => {
      const content = await res.text();
      let data;

      try {
        data = JSON.parse(text);
      } 
      catch(e) {
      alert('Відповідь не є JSON: ' + err.message);
      throw new Error('Неправильний JSON')
    }

    if(!res.ok){
      alert(data.error || "Поммилка оновлення");
      throw new Error(data.error || "Поммилка оновлення");
    }
    alert(data.message || 'Товар оновлено');
    loadItemsForEdit();
      document.getElementById('editItemForm').style.display = 'none';
    })
    .catch(err => {
      console.error('Помилка оновлення:', err);
    });
  });
})

// Редагування підкатегорії
// Підтягнути список підкатегорій у select
loadSubcategories('editSubcategoryCategorySelect', 'editSubcategorySelect'); 

// При натисканні "Вибрати" для підкатегорії
document.getElementById('loadSubcategoryDataBtn').addEventListener('click', (e) => {
  e.preventDefault();
  const subcategoryId = document.getElementById('editSubcategorySelect').value;
  if (!subcategoryId) return alert('Оберіть підкатегорію');

  fetch(`${API_BASE}/api/subcategories/id/${subcategoryId}`)
    .then(res => {
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
    })
    .then(subArray => {
      if(!Array.isArray(subArray) || subArray.length === 0){
        throw new Error('Підкатегорія не знайдена');
      }
      const sub = subArray[0];

      document.getElementById('editSubcategoryId').value = sub.id;
      document.getElementById('currentSubcategoryNameSub').textContent = sub.subcategory_name;
      document.getElementById('editSubcategoryName').value = sub.subcategory_name;

      loadCategories('editSubcategoryCategoryNameInForm', sub.category_id);
      document.getElementById('editSubcategoryForm').style.display = 'block';
      
      const container = document.getElementById('editSubcategoryForm');
      if (container) {
        container.style.display = 'block';
      } else {
        console.warn('Елемент EditSubcategoryForm не знайдено');
      }
    })
    .catch(err => {
      console.error('Помилка завантаження підкатегорії:', err);
      alert('Не вдалося завантажити дані підкатегорії');
    });
});

// Надсилання оновлення підкатегорії
document.getElementById('editSubcategoryFormElement').addEventListener('submit', function (e) {
  e.preventDefault();

  const id = document.getElementById('editSubcategoryId').value;
  const updatedSubcategory = {
    name: document.getElementById('editSubcategoryName').value,
    category_id: document.getElementById('editSubcategoryCategoryNameInForm').value
  };

  fetch(`${API_BASE}/api/subcategories/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updatedSubcategory)
  })
    .then(res => res.json())
    .then(result => {
      alert(result.message || 'Підкатегорію оновлено');
      loadCategories('editSubcategoryCategorySelect');
      document.getElementById('editSubcategoryForm').style.display = 'none';
    })
    .catch(err => {
      console.error('Помилка оновлення підкатегорії:', err);
      alert('Сталася помилка при оновленні');
    });
});

loadCategories('editCategorySelect');
// Редагування категорії
document.getElementById('loadCategoryDataBtn').addEventListener('click', (e) => {
  e.preventDefault();
  
  const categoryId = document.getElementById('editCategorySelect').value;
  if (!categoryId) return alert('Оберіть категорію');
  
  fetch(`${API_BASE}/api/categories/${categoryId}`)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })  
    .then(cat => {
      document.getElementById('editCategoryCategoryId').value = cat.category_id;
      document.getElementById('editCategoryName').value = cat.category_name || cat.name;
      document.getElementById('currentCategoryNameCat').textContent = cat.category_name;

      document.getElementById('editCategoryForm').style.display = 'block';
    })
    .catch(err => {
      console.error('Помилка при завантаженні категорій:', err);
      alert('Не вдалося завантажити дані категорії');
    });
});

// Надсилання оновлення категорії
document.getElementById('editCategoryFormElement').addEventListener('submit', function (e) {
  e.preventDefault();

  const categoryId = document.getElementById('editCategoryCategoryId')?.value;
  const updatedName = document.getElementById('editCategoryName')?.value;
  console.log('ID категорії для оновлення :', categoryId);
  
  if(!updatedName.trim()){
    return alert('Назва категорії не може бути порожньою');
  }

  fetch(`${API_BASE}/api/categories/${categoryId}`,{
    method: 'PUT',
    headers: {'Content-Type': 'application/json' },
    body: JSON.stringify({name: updatedName})
  })
    .then(res => {
      if (!res.ok) throw Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {

      const select = document.getElementById('editCategorySelect');
      const previousValue = select.value;

      loadCategories('editCategorySelect', previousValue);
      document.getElementById('editCategoryForm').style.display = 'none';
    })
    .catch(err => {
      console.error('Помилка при завантаженні категорії:', err);
      alert('Не вдалося отримати дані категорії');
    });
});

// ВИДАЛЕННЯ
// Показати форму 
 function showDeleteOptions() {
  hideAllModes();
  document.getElementById('deleteOptions').style.display = 'block';
  showForm();
}
    function showDeleteProductForm() {
  showForm('selectItemToDelete');
}
    function showDeleteCategoryForm() {
  showForm('selectCategoryToDelete');
}
    function showDeleteSubcategoryForm() {
  showForm('selectSubcategoryToDelete');
}

// Видалення товару
document.getElementById('deleteItemFormElement').addEventListener('submit', function (e) {
  e.preventDefault();
  
  const itemId = document.getElementById('itemId').value;
  const categoryId = document.getElementById('categoryId').value;
  const subcategoryId = document.getElementById('subcategoryId').value;
  const stock = document.getElementById('stock').value;
  const price = document.getElementById('price').value;

  const imgEl = document.getElementById('currentImage');
    if (imgEl) {
      imgEl.src = item.image && item.image.trim() !== '' ? item.image : '/uploads/products/no-image.jpg';
    }

  fetch(`${API_BASE}/api/products/${id}`, {
    method: 'DELETE'
  })
    .then(res => {
      if(!res.ok) throw new Error('Помилка при видалені товару');
      return res.json();
    })
    .then(result => {
      alert(result.message || 'Товар видалено');
      document.getElementById('deleteItem').reset();
    })
    .catch(err => {
      console.error(err);
      alert('Не вдалося видалити товар.');
    }); 
});

//Видалення невикористовуваних зображень
function cleanupImages() {
    fetch('/api/images/cleanup', {
      method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('cleanup-result').innerText = data.message;
    })
    .catch(error => {
      document.getElementById('cleanup-result').innerText = 'Помилка: ' + error.message;
    });
  }

  </script>
</body>
</html>
